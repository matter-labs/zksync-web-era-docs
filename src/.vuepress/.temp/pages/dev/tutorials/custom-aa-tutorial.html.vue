<template><div><h1 id="account-abstraction" tabindex="-1"><a class="header-anchor" href="#account-abstraction" aria-hidden="true">#</a> Account abstraction</h1>
<p>Now, let's learn how to deploy your custom accounts and interact directly with the <RouterLink to="/dev/developer-guides/contracts/system-contracts.html#contractdeployer">ContractDeployer</RouterLink> system contract.
In this tutorial, we build a factory that deploys 2-of-2 multisig accounts.</p>
<h2 id="prerequisite" tabindex="-1"><a class="header-anchor" href="#prerequisite" aria-hidden="true">#</a> Prerequisite</h2>
<p>It is highly recommended to read about the <RouterLink to="/dev/developer-guides/aa.html">design</RouterLink> of the account abstraction protocol before diving into this tutorial.</p>
<p>It is assumed that you are already familiar with deploying smart contracts on zkSync.
If not, please refer to the first section of the <RouterLink to="/dev/developer-guides/hello-world.html">quickstart tutorial</RouterLink>.
It is also recommended to read the <RouterLink to="/dev/developer-guides/contracts/system-contracts.html">introduction</RouterLink> to the system contracts.</p>
<h2 id="installing-dependencies" tabindex="-1"><a class="header-anchor" href="#installing-dependencies" aria-hidden="true">#</a> Installing dependencies</h2>
<p>We will use the zkSync hardhat plugin for developing this contract. Firstly, we should install all the dependencies for it:</p>
<div class="language-text line-numbers-mode" data-ext="text"><pre v-pre class="language-text"><code>mkdir custom-aa-tutorial
cd custom-aa-tutorial
yarn init -y
yarn add -D typescript ts-node ethers zksync-web3 hardhat @matterlabs/hardhat-zksync-solc @matterlabs/hardhat-zksync-deploy
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Since we are working with zkSync contracts, we also need to install the package with the contracts and its peer dependencies:</p>
<div class="language-text line-numbers-mode" data-ext="text"><pre v-pre class="language-text"><code>yarn add @matterlabs/zksync-contracts @openzeppelin/contracts @openzeppelin/contracts-upgradeable
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Also, create the <code v-pre>hardhat.config.ts</code> config file, <code v-pre>contracts</code> and <code v-pre>deploy</code> folders, like in the <RouterLink to="/dev/developer-guides/hello-world.html">quickstart tutorial</RouterLink>.</p>
<div class="hint-container tip">
<p class="hint-container-title">Tips</p>
<p>You can use the zkSync CLI to scaffold a project automatically. Find <RouterLink to="/api/tools/zksync-cli/">more info about the zkSync CLI here</RouterLink></p>
</div>
<h2 id="account-abstraction-1" tabindex="-1"><a class="header-anchor" href="#account-abstraction-1" aria-hidden="true">#</a> Account abstraction</h2>
<p>Each account needs to implement the <RouterLink to="/dev/developer-guides/aa.html#iaccount-interface">IAccount</RouterLink> interface. Since we are building an account with signers, we should also have <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/83277ff916ac4f58fec072b8f28a252c1245c2f1/contracts/interfaces/IERC1271.sol#L12" target="_blank" rel="noopener noreferrer">EIP1271<ExternalLinkIcon/></a> implemented.</p>
<p>The skeleton for the contract will look the following way:</p>
<div class="language-solidity line-numbers-mode" data-ext="solidity"><pre v-pre class="language-solidity"><code><span class="token comment">// SPDX-License-Identifier: MIT</span>
<span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">'@matterlabs/zksync-contracts/l2/system-contracts/interfaces/IAccount.sol'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'@matterlabs/zksync-contracts/l2/system-contracts/TransactionHelper.sol'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">"@openzeppelin/contracts/interfaces/IERC1271.sol"</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">TwoUserMultisig</span> <span class="token keyword">is</span> IAccount<span class="token punctuation">,</span> IERC1271 <span class="token punctuation">{</span>

    <span class="token keyword">modifier</span> <span class="token function">onlyBootloader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> BOOTLOADER_FORMAL_ADDRESS<span class="token punctuation">,</span> <span class="token string">"Only bootloader can call this method"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Continue execution if called from the bootloader.</span>
        <span class="token keyword">_</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">validateTransaction</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span> _suggestedSignedHash<span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
        <span class="token function">_validateTransaction</span><span class="token punctuation">(</span>_suggestedSignedHash<span class="token punctuation">,</span> _transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">_validateTransaction</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _suggestedSignedHash<span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">executeTransaction</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
        <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">executeTransactionFromOutside</span><span class="token punctuation">(</span>Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">{</span>
        <span class="token function">_validateTransaction</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	  <span class="token builtin">bytes4</span> <span class="token keyword">constant</span> EIP1271_SUCCESS_RETURN_VALUE <span class="token operator">=</span> <span class="token number">0x1626ba7e</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">isValidSignature</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _hash<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">calldata</span> _signature<span class="token punctuation">)</span> <span class="token keyword">public</span> override <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> EIP1271_SUCCESS_RETURN_VALUE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">payForTransaction</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">prePaymaster</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

	<span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">{</span>
        <span class="token comment">// If the bootloader called the `receive` function, it likely means</span>
        <span class="token comment">// that something went wrong and the transaction should be aborted. The bootloader should</span>
        <span class="token comment">// only interact through the `validateTransaction`/`executeTransaction` methods.</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">!=</span> BOOTLOADER_FORMAL_ADDRESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Note, that only the <RouterLink to="/dev/developer-guides/contracts/system-contracts.html#bootloader">bootloader</RouterLink> should be allowed to call the <code v-pre>validateTransaction</code>/<code v-pre>executeTransaction</code>/<code v-pre>payForTransaction</code>/<code v-pre>prePaymaster</code> methods.
That's why the <code v-pre>onlyBootloader</code> modifier is used for them.</p>
<p>The <code v-pre>executeTransactionFromOutside</code> is needed to allow external users to initiate transactions from this account. The easiest way to implement it is to do the same as <code v-pre>validateTransaction</code> + <code v-pre>executeTransaction</code> would do.</p>
<h3 id="signature-validation" tabindex="-1"><a class="header-anchor" href="#signature-validation" aria-hidden="true">#</a> Signature validation</h3>
<p>Firstly, we need to implement the signature validation process. Since we are building a two-account multisig, let's pass its owners' addresses in the constructor. In this tutorial, we use OpenZeppelin's <code v-pre>ECDSA</code> library for signature validation.</p>
<p>Add the following import:</p>
<div class="language-solidity line-numbers-mode" data-ext="solidity"><pre v-pre class="language-solidity"><code><span class="token keyword">import</span> <span class="token string">"@openzeppelin/contracts/utils/cryptography/ECDSA.sol"</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Also, add the constructor to the contract:</p>
<div class="language-solidity line-numbers-mode" data-ext="solidity"><pre v-pre class="language-solidity"><code><span class="token builtin">address</span> <span class="token keyword">public</span> owner1<span class="token punctuation">;</span>
<span class="token builtin">address</span> <span class="token keyword">public</span> owner2<span class="token punctuation">;</span>

<span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> _owner1<span class="token punctuation">,</span> <span class="token builtin">address</span> _owner2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    owner1 <span class="token operator">=</span> _owner1<span class="token punctuation">;</span>
    owner2 <span class="token operator">=</span> _owner2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>And then we can implement the <code v-pre>isValidSignature</code> method in the following way:</p>
<div class="language-solidity line-numbers-mode" data-ext="solidity"><pre v-pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">isValidSignature</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _hash<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">calldata</span> _signature<span class="token punctuation">)</span> <span class="token keyword">public</span> override <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The signature is the concatenation of the ECDSA signatures of the owners</span>
    <span class="token comment">// Each ECDSA signature is 65 bytes long. That means that the combined signature is 130 bytes long.</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>_signature<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">130</span><span class="token punctuation">,</span> <span class="token string">'Signature length is incorrect'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">address</span> recoveredAddr1 <span class="token operator">=</span> ECDSA<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>_hash<span class="token punctuation">,</span> _signature<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">address</span> recoveredAddr2 <span class="token operator">=</span> ECDSA<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>_hash<span class="token punctuation">,</span> _signature<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">:</span><span class="token number">130</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">require</span><span class="token punctuation">(</span>recoveredAddr1 <span class="token operator">==</span> owner1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>recoveredAddr2 <span class="token operator">==</span> owner2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> EIP1271_SUCCESS_RETURN_VALUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="transaction-validation" tabindex="-1"><a class="header-anchor" href="#transaction-validation" aria-hidden="true">#</a> Transaction validation</h3>
<p>Let's implement the validation process. It is responsible for validating the signature of the transaction and incrementing the nonce. Note, that there are some limitations on what this method is allowed to do. You can read more about them <RouterLink to="/dev/developer-guides/aa.html#limitations-of-the-verification-step">here</RouterLink>.</p>
<p>To increment the nonce, you should use the <code v-pre>incrementNonceIfEquals</code> method of the <code v-pre>NONCE_HOLDER_SYSTEM_CONTRACT</code> system contract. It takes the nonce of the transaction and checks whether the nonce is the same as the provided one. If not, the transaction reverts. Otherwise, the nonce is increased.</p>
<p>Even though the requirements above allows the accounts to touch only their storage slots, accessing your nonce in the <code v-pre>NONCE_HOLDER_SYSTEM_CONTRACT</code> is a <RouterLink to="/dev/developer-guides/aa.html#extending-the-set-of-slots-that-belong-to-a-user">whitelisted</RouterLink> case, since it behaves in the same way as your storage, it just happened to be in another contract. To call the <code v-pre>NONCE_HOLDER_SYSTEM_CONTRACT</code>, you should add the following import:</p>
<div class="language-solidity line-numbers-mode" data-ext="solidity"><pre v-pre class="language-solidity"><code><span class="token keyword">import</span> <span class="token string">'@matterlabs/zksync-contracts/l2/system-contracts/Constants.sol'</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>The <code v-pre>TransactionHelper</code> library (already imported in the example above) can be used to get the hash of the transaction that should be signed. You can also implement your own signature scheme and use a different commitment for the transaction to sign, but in this example we use the hash provided by this library.</p>
<p>Using the <code v-pre>TransactionHelper</code> library:</p>
<div class="language-solidity line-numbers-mode" data-ext="solidity"><pre v-pre class="language-solidity"><code><span class="token keyword">using</span> <span class="token class-name">TransactionHelper</span> <span class="token keyword">for</span> Transaction<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Also, note that since the non-view methods of the <code v-pre>NONCE_HOLDER_SYSTEM_CONTRACT</code> are required to be called with the <code v-pre>isSystem</code> flag on, the <a href="https://github.com/matter-labs/v2-testnet-contracts/blob/main/l2/system-contracts/SystemContractsCaller.sol#L77" target="_blank" rel="noopener noreferrer">systemCall<ExternalLinkIcon/></a> method of the <code v-pre>SystemContractsCaller</code> library should be used, so this library needs to be imported as well:</p>
<div class="language-solidity line-numbers-mode" data-ext="solidity"><pre v-pre class="language-solidity"><code><span class="token keyword">import</span> <span class="token string">'@matterlabs/zksync-contracts/l2/system-contracts/SystemContractsCaller.sol'</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Now we can implement the <code v-pre>_validateTransaction</code> method:</p>
<div class="language-solidity line-numbers-mode" data-ext="solidity"><pre v-pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">_validateTransaction</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _suggestedSignedHash<span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
    <span class="token comment">// Incrementing the nonce of the account.</span>
    <span class="token comment">// Note, that reserved[0] by convention is currently equal to the nonce passed in the transaction</span>
    SystemContractsCaller<span class="token punctuation">.</span><span class="token function">systemCallWithPropagatedRevert</span><span class="token punctuation">(</span>
        <span class="token builtin">uint32</span><span class="token punctuation">(</span><span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token builtin">address</span><span class="token punctuation">(</span>NONCE_HOLDER_SYSTEM_CONTRACT<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        abi<span class="token punctuation">.</span><span class="token function">encodeCall</span><span class="token punctuation">(</span>INonceHolder<span class="token punctuation">.</span>incrementMinNonceIfEquals<span class="token punctuation">,</span> <span class="token punctuation">(</span>_transaction<span class="token punctuation">.</span>reserved<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">bytes32</span> txHash<span class="token punctuation">;</span>
    <span class="token comment">// While the suggested signed hash is usually provided, it is generally</span>
    <span class="token comment">// not recommended to rely on it to be present, since in the future</span>
    <span class="token comment">// there may be tx types with no suggested signed hash.</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>_suggestedSignedHash <span class="token operator">==</span> <span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        txHash <span class="token operator">=</span> _transaction<span class="token punctuation">.</span><span class="token function">encodeHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        txHash <span class="token operator">=</span> _suggestedSignedHash<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token function">isValidSignature</span><span class="token punctuation">(</span>txHash<span class="token punctuation">,</span> _transaction<span class="token punctuation">.</span>signature<span class="token punctuation">)</span> <span class="token operator">==</span> EIP1271_SUCCESS_RETURN_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="paying-fees-for-the-transaction" tabindex="-1"><a class="header-anchor" href="#paying-fees-for-the-transaction" aria-hidden="true">#</a> Paying fees for the transaction</h3>
<p>We should now implement the <code v-pre>payForTransaction</code> method. The <code v-pre>TransactionHelper</code> library already provides us with the <code v-pre>payToTheBootloader</code> method, that sends <code v-pre>_transaction.maxFeePerErg * _transaction.ergsLimit</code> ETH to the bootloader. So the implementation is rather straightforward:</p>
<div class="language-solidity line-numbers-mode" data-ext="solidity"><pre v-pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">payForTransaction</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
		<span class="token builtin">bool</span> success <span class="token operator">=</span> _transaction<span class="token punctuation">.</span><span class="token function">payToTheBootloader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">"Failed to pay the fee to the operator"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="implementing-prepaymaster" tabindex="-1"><a class="header-anchor" href="#implementing-prepaymaster" aria-hidden="true">#</a> Implementing <code v-pre>prePaymaster</code></h3>
<p>While generally the account abstraction protocol enables performing arbitrary actions when interacting with the paymasters, there are some <RouterLink to="/dev/developer-guides/aa.html#built-in-paymaster-flows">common patterns</RouterLink> with the built-in support from EOAs.
Unless you want to implement or restrict some specific paymaster use cases from your account, it is better to keep it consistent with EOAs. The <code v-pre>TransactionHelper</code> library provides the <code v-pre>processPaymasterInput</code> which does exactly that: processed the <code v-pre>prePaymaster</code> step the same as EOA does.</p>
<div class="language-solidity line-numbers-mode" data-ext="solidity"><pre v-pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">prePaymaster</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
    _transaction<span class="token punctuation">.</span><span class="token function">processPaymasterInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="transaction-execution" tabindex="-1"><a class="header-anchor" href="#transaction-execution" aria-hidden="true">#</a> Transaction execution</h3>
<p>The most basic implementation of the transaction execution is quite straightforward:</p>
<div class="language-solidity line-numbers-mode" data-ext="solidity"><pre v-pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
    <span class="token builtin">uint256</span> to <span class="token operator">=</span> _transaction<span class="token punctuation">.</span>to<span class="token punctuation">;</span>
    <span class="token comment">// By convention, the `reserved[1]` field is msg.value</span>
    <span class="token builtin">uint256</span> value <span class="token operator">=</span> _transaction<span class="token punctuation">.</span>reserved<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> data <span class="token operator">=</span> _transaction<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

    <span class="token builtin">bool</span> success<span class="token punctuation">;</span>
    <span class="token keyword">assembly</span> <span class="token punctuation">{</span>
        success <span class="token operator">:=</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token function">gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> to<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mload</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Needed for the transaction to be correctly processed by the server.</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>However, note that calling ContractDeployer is only possible with the <code v-pre>isSystem</code> call flag. In order to permit your users to deploy contracts, you should do so explicitly:</p>
<div class="language-solidity line-numbers-mode" data-ext="solidity"><pre v-pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
    <span class="token builtin">address</span> to <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token builtin">uint160</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">.</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">uint256</span> value <span class="token operator">=</span> _transaction<span class="token punctuation">.</span>reserved<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> data <span class="token operator">=</span> _transaction<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>to <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span>DEPLOYER_SYSTEM_CONTRACT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// We allow calling ContractDeployer with any calldata</span>
        SystemContractsCaller<span class="token punctuation">.</span><span class="token function">systemCallWithPropagatedRevert</span><span class="token punctuation">(</span>
            <span class="token builtin">uint32</span><span class="token punctuation">(</span><span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            to<span class="token punctuation">,</span>
            <span class="token builtin">uint128</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">.</span>reserved<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// By convention, reserved[1] is `value`</span>
            _transaction<span class="token punctuation">.</span>data
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token builtin">bool</span> success<span class="token punctuation">;</span>
        <span class="token keyword">assembly</span> <span class="token punctuation">{</span>
            success <span class="token operator">:=</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token function">gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> to<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mload</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Note, that whether the operator will consider the transaction successful will depend only on whether the call to <code v-pre>executeTransactions</code> was successful. Therefore, it is highly recommended to put <code v-pre>require(success)</code> for the transaction, so that users get the best UX.</p>
<h3 id="full-code-of-the-account" tabindex="-1"><a class="header-anchor" href="#full-code-of-the-account" aria-hidden="true">#</a> Full code of the account</h3>
<div class="language-solidity line-numbers-mode" data-ext="solidity"><pre v-pre class="language-solidity"><code><span class="token comment">// SPDX-License-Identifier: MIT</span>
<span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">"@matterlabs/zksync-contracts/l2/system-contracts/interfaces/IAccount.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">"@matterlabs/zksync-contracts/l2/system-contracts/TransactionHelper.sol"</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">"@openzeppelin/contracts/interfaces/IERC1271.sol"</span><span class="token punctuation">;</span>

<span class="token comment">// Used for signature validation</span>
<span class="token keyword">import</span> <span class="token string">"@openzeppelin/contracts/utils/cryptography/ECDSA.sol"</span><span class="token punctuation">;</span>

<span class="token comment">// Access zkSync system contracts, in this case for nonce validation vs NONCE_HOLDER_SYSTEM_CONTRACT</span>
<span class="token keyword">import</span> <span class="token string">"@matterlabs/zksync-contracts/l2/system-contracts/Constants.sol"</span><span class="token punctuation">;</span>
<span class="token comment">// to call non-view method of system contracts</span>
<span class="token keyword">import</span> <span class="token string">"@matterlabs/zksync-contracts/l2/system-contracts/SystemContractsCaller.sol"</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">TwoUserMultisig</span> <span class="token keyword">is</span> IAccount<span class="token punctuation">,</span> IERC1271 <span class="token punctuation">{</span>
    <span class="token comment">// to get transaction hash</span>
    <span class="token keyword">using</span> <span class="token class-name">TransactionHelper</span> <span class="token keyword">for</span> Transaction<span class="token punctuation">;</span>

    <span class="token comment">// state variables for account owners</span>
    <span class="token builtin">address</span> <span class="token keyword">public</span> owner1<span class="token punctuation">;</span>
    <span class="token builtin">address</span> <span class="token keyword">public</span> owner2<span class="token punctuation">;</span>

    <span class="token builtin">bytes4</span> <span class="token keyword">constant</span> EIP1271_SUCCESS_RETURN_VALUE <span class="token operator">=</span> <span class="token number">0x1626ba7e</span><span class="token punctuation">;</span>

    <span class="token keyword">modifier</span> <span class="token function">onlyBootloader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>
            msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> BOOTLOADER_FORMAL_ADDRESS<span class="token punctuation">,</span>
            <span class="token string">"Only bootloader can call this method"</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Continue execution if called from the bootloader.</span>
        <span class="token keyword">_</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> _owner1<span class="token punctuation">,</span> <span class="token builtin">address</span> _owner2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        owner1 <span class="token operator">=</span> _owner1<span class="token punctuation">;</span>
        owner2 <span class="token operator">=</span> _owner2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">validateTransaction</span><span class="token punctuation">(</span>
        <span class="token builtin">bytes32</span><span class="token punctuation">,</span>
        <span class="token builtin">bytes32</span> _suggestedSignedHash<span class="token punctuation">,</span>
        Transaction <span class="token keyword">calldata</span> _transaction
    <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
        <span class="token function">_validateTransaction</span><span class="token punctuation">(</span>_suggestedSignedHash<span class="token punctuation">,</span> _transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">_validateTransaction</span><span class="token punctuation">(</span>
        <span class="token builtin">bytes32</span> _suggestedSignedHash<span class="token punctuation">,</span>
        Transaction <span class="token keyword">calldata</span> _transaction
    <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
        <span class="token comment">// Incrementing the nonce of the account.</span>
        <span class="token comment">// Note, that reserved[0] by convention is currently equal to the nonce passed in the transaction</span>
        SystemContractsCaller<span class="token punctuation">.</span><span class="token function">systemCallWithPropagatedRevert</span><span class="token punctuation">(</span>
            <span class="token builtin">uint32</span><span class="token punctuation">(</span><span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">address</span><span class="token punctuation">(</span>NONCE_HOLDER_SYSTEM_CONTRACT<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            abi<span class="token punctuation">.</span><span class="token function">encodeCall</span><span class="token punctuation">(</span>
                INonceHolder<span class="token punctuation">.</span>incrementMinNonceIfEquals<span class="token punctuation">,</span>
                <span class="token punctuation">(</span>_transaction<span class="token punctuation">.</span>reserved<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token builtin">bytes32</span> txHash<span class="token punctuation">;</span>
        <span class="token comment">// While the suggested signed hash is usually provided, it is generally</span>
        <span class="token comment">// not recommended to rely on it to be present, since in the future</span>
        <span class="token comment">// there may be tx types with no suggested signed hash.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_suggestedSignedHash <span class="token operator">==</span> <span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            txHash <span class="token operator">=</span> _transaction<span class="token punctuation">.</span><span class="token function">encodeHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            txHash <span class="token operator">=</span> _suggestedSignedHash<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">require</span><span class="token punctuation">(</span>
            <span class="token function">isValidSignature</span><span class="token punctuation">(</span>txHash<span class="token punctuation">,</span> _transaction<span class="token punctuation">.</span>signature<span class="token punctuation">)</span> <span class="token operator">==</span>
                EIP1271_SUCCESS_RETURN_VALUE
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">executeTransaction</span><span class="token punctuation">(</span>
        <span class="token builtin">bytes32</span><span class="token punctuation">,</span>
        <span class="token builtin">bytes32</span><span class="token punctuation">,</span>
        Transaction <span class="token keyword">calldata</span> _transaction
    <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
        <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
        <span class="token builtin">address</span> to <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token builtin">uint160</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">.</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> value <span class="token operator">=</span> _transaction<span class="token punctuation">.</span>reserved<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token builtin">bytes</span> <span class="token keyword">memory</span> data <span class="token operator">=</span> _transaction<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>to <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span>DEPLOYER_SYSTEM_CONTRACT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// We allow calling ContractDeployer with any calldata</span>
            SystemContractsCaller<span class="token punctuation">.</span><span class="token function">systemCallWithPropagatedRevert</span><span class="token punctuation">(</span>
                <span class="token builtin">uint32</span><span class="token punctuation">(</span><span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                to<span class="token punctuation">,</span>
                <span class="token builtin">uint128</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">.</span>reserved<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// By convention, reserved[1] is `value`</span>
                _transaction<span class="token punctuation">.</span>data
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token builtin">bool</span> success<span class="token punctuation">;</span>
            <span class="token keyword">assembly</span> <span class="token punctuation">{</span>
                success <span class="token operator">:=</span> <span class="token function">call</span><span class="token punctuation">(</span>
                    <span class="token function">gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    to<span class="token punctuation">,</span>
                    value<span class="token punctuation">,</span>
                    <span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">mload</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token number">0</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">executeTransactionFromOutside</span><span class="token punctuation">(</span>Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span>
        <span class="token keyword">external</span>
        <span class="token keyword">payable</span>
    <span class="token punctuation">{</span>
        <span class="token function">_validateTransaction</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">isValidSignature</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _hash<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">calldata</span> _signature<span class="token punctuation">)</span>
        <span class="token keyword">public</span>
        <span class="token keyword">view</span>
        override
        <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes4</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// The signature is the concatenation of the ECDSA signatures of the owners</span>
        <span class="token comment">// Each ECDSA signature is 65 bytes long. That means that the combined signature is 130 bytes long.</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>_signature<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">130</span><span class="token punctuation">,</span> <span class="token string">"Signature length is incorrect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token builtin">address</span> recoveredAddr1 <span class="token operator">=</span> ECDSA<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>_hash<span class="token punctuation">,</span> _signature<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">address</span> recoveredAddr2 <span class="token operator">=</span> ECDSA<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>_hash<span class="token punctuation">,</span> _signature<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">:</span><span class="token number">130</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">require</span><span class="token punctuation">(</span>recoveredAddr1 <span class="token operator">==</span> owner1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>recoveredAddr2 <span class="token operator">==</span> owner2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> EIP1271_SUCCESS_RETURN_VALUE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">payForTransaction</span><span class="token punctuation">(</span>
        <span class="token builtin">bytes32</span><span class="token punctuation">,</span>
        <span class="token builtin">bytes32</span><span class="token punctuation">,</span>
        Transaction <span class="token keyword">calldata</span> _transaction
    <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
        <span class="token builtin">bool</span> success <span class="token operator">=</span> _transaction<span class="token punctuation">.</span><span class="token function">payToTheBootloader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">"Failed to pay the fee to the operator"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">prePaymaster</span><span class="token punctuation">(</span>
        <span class="token builtin">bytes32</span><span class="token punctuation">,</span>
        <span class="token builtin">bytes32</span><span class="token punctuation">,</span>
        Transaction <span class="token keyword">calldata</span> _transaction
    <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
        _transaction<span class="token punctuation">.</span><span class="token function">processPaymasterInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">{</span>
        <span class="token comment">// If the bootloader called the `receive` function, it likely means</span>
        <span class="token comment">// that something went wrong and the transaction should be aborted. The bootloader should</span>
        <span class="token comment">// only interact through the `validateTransaction`/`executeTransaction` methods.</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">!=</span> BOOTLOADER_FORMAL_ADDRESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="the-factory" tabindex="-1"><a class="header-anchor" href="#the-factory" aria-hidden="true">#</a> The factory</h2>
<p>Now, let's build a factory that can deploy these accounts. Note, that if we want to deploy AA, we need to interact directly with the <code v-pre>DEPLOYER_SYSTEM_CONTRACT</code>. For deterministic addresses, we will use <code v-pre>create2Account</code> method.</p>
<p>The code will look the following way:</p>
<div class="language-solidity line-numbers-mode" data-ext="solidity"><pre v-pre class="language-solidity"><code><span class="token comment">// SPDX-License-Identifier: MIT</span>
<span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">"@matterlabs/zksync-contracts/l2/system-contracts/Constants.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">"@matterlabs/zksync-contracts/l2/system-contracts/SystemContractsCaller.sol"</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">AAFactory</span> <span class="token punctuation">{</span>
    <span class="token builtin">bytes32</span> <span class="token keyword">public</span> aaBytecodeHash<span class="token punctuation">;</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _aaBytecodeHash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        aaBytecodeHash <span class="token operator">=</span> _aaBytecodeHash<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">deployAccount</span><span class="token punctuation">(</span>
        <span class="token builtin">bytes32</span> salt<span class="token punctuation">,</span>
        <span class="token builtin">address</span> owner1<span class="token punctuation">,</span>
        <span class="token builtin">address</span> owner2
    <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">address</span> accountAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token builtin">bool</span> success<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> returnData<span class="token punctuation">)</span> <span class="token operator">=</span> SystemContractsCaller
            <span class="token punctuation">.</span><span class="token function">systemCallWithReturndata</span><span class="token punctuation">(</span>
                <span class="token builtin">uint32</span><span class="token punctuation">(</span><span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token builtin">address</span><span class="token punctuation">(</span>DEPLOYER_SYSTEM_CONTRACT<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token builtin">uint128</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                abi<span class="token punctuation">.</span><span class="token function">encodeCall</span><span class="token punctuation">(</span>
                    DEPLOYER_SYSTEM_CONTRACT<span class="token punctuation">.</span>create2Account<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>salt<span class="token punctuation">,</span> aaBytecodeHash<span class="token punctuation">,</span> abi<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>owner1<span class="token punctuation">,</span> owner2<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">"Deployment failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">(</span>accountAddress<span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>returnData<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Note, that on zkSync, the deployment is not done via bytecode, but via bytecode hash. The bytecode itself is passed to the operator via <code v-pre>factoryDeps</code> field. Note, that the <code v-pre>_aaBytecodeHash</code> must be formed specially:</p>
<ul>
<li>Firstly, it is hashed with sha256.</li>
<li>Then, the first two bytes are replaced with the length of the bytecode in 32-byte words.</li>
</ul>
<p>You don't need to worry about it, since our SDK provides a built-in method to do it, explained below.</p>
<h2 id="deploying-the-factory" tabindex="-1"><a class="header-anchor" href="#deploying-the-factory" aria-hidden="true">#</a> Deploying the factory</h2>
<p>To deploy a factory, we need to create a deployment script. Create the <code v-pre>deploy</code> folder and create one file there: <code v-pre>deploy-factory.ts</code>. Put the following deployment script there:</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> utils<span class="token punctuation">,</span> Wallet <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"zksync-web3"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> ethers <span class="token keyword">from</span> <span class="token string">"ethers"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HardhatRuntimeEnvironment <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"hardhat/types"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Deployer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@matterlabs/hardhat-zksync-deploy"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>hre<span class="token operator">:</span> HardhatRuntimeEnvironment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> wallet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wallet</span><span class="token punctuation">(</span><span class="token string">"&lt;PRIVATE-KEY>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> deployer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Deployer</span><span class="token punctuation">(</span>hre<span class="token punctuation">,</span> wallet<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> factoryArtifact <span class="token operator">=</span> <span class="token keyword">await</span> deployer<span class="token punctuation">.</span><span class="token function">loadArtifact</span><span class="token punctuation">(</span><span class="token string">"AAFactory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> aaArtifact <span class="token operator">=</span> <span class="token keyword">await</span> deployer<span class="token punctuation">.</span><span class="token function">loadArtifact</span><span class="token punctuation">(</span><span class="token string">"TwoUserMultisig"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Deposit some funds to L2 in order to be able to perform L2 transactions.</span>
  <span class="token comment">// You can remove the depositing step if the `wallet` has enough funds on zkSync</span>
  <span class="token keyword">const</span> depositAmount <span class="token operator">=</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">parseEther</span><span class="token punctuation">(</span><span class="token string">"0.001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> depositHandle <span class="token operator">=</span> <span class="token keyword">await</span> deployer<span class="token punctuation">.</span>zkWallet<span class="token punctuation">.</span><span class="token function">deposit</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    to<span class="token operator">:</span> deployer<span class="token punctuation">.</span>zkWallet<span class="token punctuation">.</span>address<span class="token punctuation">,</span>
    token<span class="token operator">:</span> utils<span class="token punctuation">.</span><span class="token constant">ETH_ADDRESS</span><span class="token punctuation">,</span>
    amount<span class="token operator">:</span> depositAmount<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> depositHandle<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Getting the bytecodeHash of the account</span>
  <span class="token keyword">const</span> bytecodeHash <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">hashBytecode</span><span class="token punctuation">(</span>aaArtifact<span class="token punctuation">.</span>bytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> factory <span class="token operator">=</span> <span class="token keyword">await</span> deployer<span class="token punctuation">.</span><span class="token function">deploy</span><span class="token punctuation">(</span>factoryArtifact<span class="token punctuation">,</span> <span class="token punctuation">[</span>bytecodeHash<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token comment">// Since the factory requires the code of the multisig to be available,</span>
    <span class="token comment">// we should pass it here as well.</span>
    aaArtifact<span class="token punctuation">.</span>bytecode<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">AA factory address: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>factory<span class="token punctuation">.</span>address<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>In order to deploy the factory, you should compile the contracts and run the script:</p>
<div class="language-text line-numbers-mode" data-ext="text"><pre v-pre class="language-text"><code>yarn hardhat compile
yarn hardhat deploy-zksync --script deploy-factory.ts
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>The output should be roughly the following:</p>
<div class="language-text line-numbers-mode" data-ext="text"><pre v-pre class="language-text"><code>AA factory address: 0x9db333Cb68Fb6D317E3E415269a5b9bE7c72627Ds
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Note that the address will be different for each run.</p>
<h2 id="working-with-accounts" tabindex="-1"><a class="header-anchor" href="#working-with-accounts" aria-hidden="true">#</a> Working with accounts</h2>
<h3 id="deploying-an-account" tabindex="-1"><a class="header-anchor" href="#deploying-an-account" aria-hidden="true">#</a> Deploying an account</h3>
<p>Now, let's deploy an account and initiate a new transaction with it. In this section, we assume that you already have an EOA account with enough funds on zkSync.
In the <code v-pre>deploy</code>, folder creates a file <code v-pre>deploy-multisig.ts</code>, where we will put the script.</p>
<p>Firstly, let's deploy the AA. This will be a call to the <code v-pre>deployAccount</code> function:</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> utils<span class="token punctuation">,</span> Wallet<span class="token punctuation">,</span> Provider<span class="token punctuation">,</span> EIP712Signer<span class="token punctuation">,</span> types <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"zksync-web3"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> ethers <span class="token keyword">from</span> <span class="token string">"ethers"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HardhatRuntimeEnvironment <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"hardhat/types"</span><span class="token punctuation">;</span>

<span class="token comment">// Put the address of your AA factory</span>
<span class="token keyword">const</span> <span class="token constant">AA_FACTORY_ADDRESS</span> <span class="token operator">=</span> <span class="token string">"&lt;FACTORY-ADDRESS>"</span><span class="token punctuation">;</span>

<span class="token comment">// An example of a deploy script deploys and calls a simple contract.</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>hre<span class="token operator">:</span> HardhatRuntimeEnvironment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Provider</span><span class="token punctuation">(</span><span class="token string">"https://zksync2-testnet.zksync.dev"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> wallet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wallet</span><span class="token punctuation">(</span><span class="token string">"&lt;WALLET-PRIVATE-KEY>"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> factoryArtifact <span class="token operator">=</span> <span class="token keyword">await</span> hre<span class="token punctuation">.</span>artifacts<span class="token punctuation">.</span><span class="token function">readArtifact</span><span class="token punctuation">(</span><span class="token string">"AAFactory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> aaFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers</span><span class="token punctuation">.</span><span class="token function">Contract</span><span class="token punctuation">(</span><span class="token constant">AA_FACTORY_ADDRESS</span><span class="token punctuation">,</span> factoryArtifact<span class="token punctuation">.</span>abi<span class="token punctuation">,</span> wallet<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// The two owners of the multisig</span>
  <span class="token keyword">const</span> owner1 <span class="token operator">=</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> owner2 <span class="token operator">=</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// For the simplicity of the tutorial, we will use zero hash as salt</span>
  <span class="token keyword">const</span> salt <span class="token operator">=</span> ethers<span class="token punctuation">.</span>constants<span class="token punctuation">.</span>HashZero<span class="token punctuation">;</span>

  <span class="token keyword">const</span> tx <span class="token operator">=</span> <span class="token keyword">await</span> aaFactory<span class="token punctuation">.</span><span class="token function">deployAccount</span><span class="token punctuation">(</span>salt<span class="token punctuation">,</span> owner1<span class="token punctuation">.</span>address<span class="token punctuation">,</span> owner2<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> tx<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Getting the address of the deployed contract</span>
  <span class="token keyword">const</span> abiCoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">AbiCoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> multisigAddress <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">create2Address</span><span class="token punctuation">(</span>
    <span class="token constant">AA_FACTORY_ADDRESS</span><span class="token punctuation">,</span>
    <span class="token keyword">await</span> aaFactory<span class="token punctuation">.</span><span class="token function">aaBytecodeHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    salt<span class="token punctuation">,</span>
    abiCoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"address"</span><span class="token punctuation">,</span> <span class="token string">"address"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>owner1<span class="token punctuation">.</span>address<span class="token punctuation">,</span> owner2<span class="token punctuation">.</span>address<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Deployed on address </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>multisigAddress<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><em>Note, that zkSync has different address derivation rules from Ethereum</em>. You should always use the <code v-pre>createAddress</code> and <code v-pre>create2Address</code> utility methods of the <code v-pre>zksync-web3</code> SDK.</p>
<h3 id="starting-a-transaction-from-this-account" tabindex="-1"><a class="header-anchor" href="#starting-a-transaction-from-this-account" aria-hidden="true">#</a> Starting a transaction from this account</h3>
<p>Before the deployed account can do any transactions, we need to top it up:</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token keyword">await</span><span class="token punctuation">(</span>
  <span class="token keyword">await</span> wallet<span class="token punctuation">.</span><span class="token function">sendTransaction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    to<span class="token operator">:</span> multisigAddress<span class="token punctuation">,</span>
    <span class="token comment">// You can increase the amount of ETH sent to the multisig</span>
    value<span class="token operator">:</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">parseEther</span><span class="token punctuation">(</span><span class="token string">"0.003"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now, as an example, let's try to deploy a new multisig, but the initiator of the transaction will be our deployed account from the previous part:</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token keyword">let</span> aaTx <span class="token operator">=</span> <span class="token keyword">await</span> aaFactory<span class="token punctuation">.</span>populateTransaction<span class="token punctuation">.</span><span class="token function">deployAccount</span><span class="token punctuation">(</span>salt<span class="token punctuation">,</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address<span class="token punctuation">,</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Then, we need to fill all the transaction fields:</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token keyword">const</span> gasLimit <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">estimateGas</span><span class="token punctuation">(</span>aaTx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> gasPrice <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getGasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

aaTx <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>aaTx<span class="token punctuation">,</span>
  from<span class="token operator">:</span> multisigAddress<span class="token punctuation">,</span>
  gasLimit<span class="token operator">:</span> gasLimit<span class="token punctuation">,</span>
  gasPrice<span class="token operator">:</span> gasPrice<span class="token punctuation">,</span>
  chainId<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getNetwork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>chainId<span class="token punctuation">,</span>
  nonce<span class="token operator">:</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getTransactionCount</span><span class="token punctuation">(</span>multisigAddress<span class="token punctuation">)</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token number">113</span><span class="token punctuation">,</span>
  customData<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// Note, that we are using the `DEFAULT_ERGS_PER_PUBDATA_LIMIT`</span>
    ergsPerPubdata<span class="token operator">:</span> utils<span class="token punctuation">.</span><span class="token constant">DEFAULT_ERGS_PER_PUBDATA_LIMIT</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token keyword">as</span> types<span class="token punctuation">.</span>Eip712Meta<span class="token punctuation">,</span>
  value<span class="token operator">:</span> ethers<span class="token punctuation">.</span>BigNumber<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip">
<p class="hint-container-title">Note on gasLimit</p>
<p>Currently, we expect the <code v-pre>gasLimit</code> to cover both the verification and the execution steps. Currently, the number of ergs that is returned by the <code v-pre>estimateGas</code> is <code v-pre>execution_ergs + 20000</code>, where <code v-pre>20000</code> is roughly equal to the overhead needed for the defaultAA to have both fee charged and the signature verified. In case your AA has a very expensive verification step, you should add some constant to the <code v-pre>gasLimit</code>.</p>
</div>
<p>Then, we need to sign the transaction and provide the <code v-pre>aaParamas</code> in the customData of the transaction:</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token keyword">const</span> signedTxHash <span class="token operator">=</span> EIP712Signer<span class="token punctuation">.</span><span class="token function">getSignedDigest</span><span class="token punctuation">(</span>aaTx<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> signature <span class="token operator">=</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token comment">// Note, that `signMessage` wouldn't work here, since we don't want</span>
  <span class="token comment">// the signed hash to be prefixed with `\x19Ethereum Signed Message:\n`</span>
  ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">joinSignature</span><span class="token punctuation">(</span>owner1<span class="token punctuation">.</span><span class="token function">_signingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">signDigest</span><span class="token punctuation">(</span>signedTxHash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">joinSignature</span><span class="token punctuation">(</span>owner2<span class="token punctuation">.</span><span class="token function">_signingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">signDigest</span><span class="token punctuation">(</span>signedTxHash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

aaTx<span class="token punctuation">.</span>customData <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>aaTx<span class="token punctuation">.</span>customData<span class="token punctuation">,</span>
  customSignature<span class="token operator">:</span> signature<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now, we are ready to send the transaction:</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The multisig's nonce before the first tx is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getTransactionCount</span><span class="token punctuation">(</span>multisigAddress<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sentTx <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">sendTransaction</span><span class="token punctuation">(</span>utils<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>aaTx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> sentTx<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Checking that the nonce for the account has increased</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The multisig's nonce after the first tx is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getTransactionCount</span><span class="token punctuation">(</span>multisigAddress<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="full-example" tabindex="-1"><a class="header-anchor" href="#full-example" aria-hidden="true">#</a> Full example</h3>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> utils<span class="token punctuation">,</span> Wallet<span class="token punctuation">,</span> Provider<span class="token punctuation">,</span> EIP712Signer<span class="token punctuation">,</span> types <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"zksync-web3"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> ethers <span class="token keyword">from</span> <span class="token string">"ethers"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HardhatRuntimeEnvironment <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"hardhat/types"</span><span class="token punctuation">;</span>

<span class="token comment">// Put the address of your AA factory</span>
<span class="token keyword">const</span> <span class="token constant">AA_FACTORY_ADDRESS</span> <span class="token operator">=</span> <span class="token string">"&lt;FACTORY-ADDRESS>"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>hre<span class="token operator">:</span> HardhatRuntimeEnvironment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Provider</span><span class="token punctuation">(</span><span class="token string">"https://zksync2-testnet.zksync.dev"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> wallet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wallet</span><span class="token punctuation">(</span><span class="token string">"&lt;WALLET_PRIVATE_KEY>"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> factoryArtifact <span class="token operator">=</span> <span class="token keyword">await</span> hre<span class="token punctuation">.</span>artifacts<span class="token punctuation">.</span><span class="token function">readArtifact</span><span class="token punctuation">(</span><span class="token string">"AAFactory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> aaFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers</span><span class="token punctuation">.</span><span class="token function">Contract</span><span class="token punctuation">(</span><span class="token constant">AA_FACTORY_ADDRESS</span><span class="token punctuation">,</span> factoryArtifact<span class="token punctuation">.</span>abi<span class="token punctuation">,</span> wallet<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// The two owners of the multisig</span>
  <span class="token keyword">const</span> owner1 <span class="token operator">=</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> owner2 <span class="token operator">=</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// For the simplicity of the tutorial, we will use zero hash as salt</span>
  <span class="token keyword">const</span> salt <span class="token operator">=</span> ethers<span class="token punctuation">.</span>constants<span class="token punctuation">.</span>HashZero<span class="token punctuation">;</span>

  <span class="token keyword">const</span> tx <span class="token operator">=</span> <span class="token keyword">await</span> aaFactory<span class="token punctuation">.</span><span class="token function">deployAccount</span><span class="token punctuation">(</span>salt<span class="token punctuation">,</span> owner1<span class="token punctuation">.</span>address<span class="token punctuation">,</span> owner2<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> tx<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Getting the address of the deployed contract</span>
  <span class="token keyword">const</span> abiCoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">AbiCoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> multisigAddress <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">create2Address</span><span class="token punctuation">(</span>
    <span class="token constant">AA_FACTORY_ADDRESS</span><span class="token punctuation">,</span>
    <span class="token keyword">await</span> aaFactory<span class="token punctuation">.</span><span class="token function">aaBytecodeHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    salt<span class="token punctuation">,</span>
    abiCoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"address"</span><span class="token punctuation">,</span> <span class="token string">"address"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>owner1<span class="token punctuation">.</span>address<span class="token punctuation">,</span> owner2<span class="token punctuation">.</span>address<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Multisig deployed on address </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>multisigAddress<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> <span class="token punctuation">(</span>
    <span class="token keyword">await</span> wallet<span class="token punctuation">.</span><span class="token function">sendTransaction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      to<span class="token operator">:</span> multisigAddress<span class="token punctuation">,</span>
      <span class="token comment">// You can increase the amount of ETH sent to the multisig</span>
      value<span class="token operator">:</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">parseEther</span><span class="token punctuation">(</span><span class="token string">"0.001"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> aaTx <span class="token operator">=</span> <span class="token keyword">await</span> aaFactory<span class="token punctuation">.</span>populateTransaction<span class="token punctuation">.</span><span class="token function">deployAccount</span><span class="token punctuation">(</span>salt<span class="token punctuation">,</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address<span class="token punctuation">,</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> gasLimit <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">estimateGas</span><span class="token punctuation">(</span>aaTx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> gasPrice <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getGasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  aaTx <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>aaTx<span class="token punctuation">,</span>
    from<span class="token operator">:</span> multisigAddress<span class="token punctuation">,</span>
    gasLimit<span class="token operator">:</span> gasLimit<span class="token punctuation">,</span>
    gasPrice<span class="token operator">:</span> gasPrice<span class="token punctuation">,</span>
    chainId<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getNetwork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>chainId<span class="token punctuation">,</span>
    nonce<span class="token operator">:</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getTransactionCount</span><span class="token punctuation">(</span>multisigAddress<span class="token punctuation">)</span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token number">113</span><span class="token punctuation">,</span>
    customData<span class="token operator">:</span> <span class="token punctuation">{</span>
      ergsPerPubdata<span class="token operator">:</span> utils<span class="token punctuation">.</span><span class="token constant">DEFAULT_ERGS_PER_PUBDATA_LIMIT</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token keyword">as</span> types<span class="token punctuation">.</span>Eip712Meta<span class="token punctuation">,</span>
    value<span class="token operator">:</span> ethers<span class="token punctuation">.</span>BigNumber<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> signedTxHash <span class="token operator">=</span> EIP712Signer<span class="token punctuation">.</span><span class="token function">getSignedDigest</span><span class="token punctuation">(</span>aaTx<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> signature <span class="token operator">=</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token comment">// Note, that `signMessage` wouldn't work here, since we don't want</span>
    <span class="token comment">// the signed hash to be prefixed with `\x19Ethereum Signed Message:\n`</span>
    ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">joinSignature</span><span class="token punctuation">(</span>owner1<span class="token punctuation">.</span><span class="token function">_signingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">signDigest</span><span class="token punctuation">(</span>signedTxHash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">joinSignature</span><span class="token punctuation">(</span>owner2<span class="token punctuation">.</span><span class="token function">_signingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">signDigest</span><span class="token punctuation">(</span>signedTxHash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  aaTx<span class="token punctuation">.</span>customData <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>aaTx<span class="token punctuation">.</span>customData<span class="token punctuation">,</span>
    customSignature<span class="token operator">:</span> signature<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The multisig's nonce before the first tx is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getTransactionCount</span><span class="token punctuation">(</span>multisigAddress<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> sentTx <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">sendTransaction</span><span class="token punctuation">(</span>utils<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>aaTx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> sentTx<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Checking that the nonce for the account has increased</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The multisig's nonce after the first tx is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getTransactionCount</span><span class="token punctuation">(</span>multisigAddress<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>To run the script, use the following command:</p>
<div class="language-text line-numbers-mode" data-ext="text"><pre v-pre class="language-text"><code>yarn hardhat deploy-zksync --script deploy-multisig.ts
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>The output should be roughly the following:</p>
<div class="language-text line-numbers-mode" data-ext="text"><pre v-pre class="language-text"><code>Multisig deployed on address 0xCEBc59558938bccb43A6C94769F87bBdb770E956
The multisig's nonce before the first tx is 0
The multisig's nonce after the first tx is 1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip">
<p class="hint-container-title">Tips</p>
<p>If you get an error <code v-pre>Not enough balance to cover the fee.</code>, try increasing the amount of ETH sent to the multisig wallet so it has enough funds to pay for the transaction fees.</p>
</div>
<h2 id="complete-project" tabindex="-1"><a class="header-anchor" href="#complete-project" aria-hidden="true">#</a> Complete project</h2>
<p>You can download the complete project <a href="https://github.com/matter-labs/custom-aa-tutorial" target="_blank" rel="noopener noreferrer">here<ExternalLinkIcon/></a>.</p>
<h2 id="learn-more" tabindex="-1"><a class="header-anchor" href="#learn-more" aria-hidden="true">#</a> Learn more</h2>
<ul>
<li>To learn more about L1-&gt;L2 interaction on zkSync, check out the <RouterLink to="/dev/developer-guides/bridging/l1-l2.html">documentation</RouterLink>.</li>
<li>To learn more about the <code v-pre>zksync-web3</code> SDK, check out its <a href="../../api/js">documentation</a>.</li>
<li>To learn more about the zkSync hardhat plugins, check out their <a href="../../api/hardhat">documentation</a>.</li>
</ul>
</div></template>


