import{colors as $,fs as x}from"@vuepress/utils";import{Logger as P}from"vuepress-shared/node";import{isLinkHttp as T,removeEndingSlash as b,removeLeadingSlash as O}from"@vuepress/shared";import{SitemapStream as D}from"sitemap";const d=new P("vuepress-plugin-sitemap2"),S=({options:e,deprecatedOption:n,newOption:a,msg:s="",scope:p=""})=>{if(n in e){if(d.warn(`${$.magenta(n)} is ${$.yellow("deprecated")}${p?` in ${p}`:""}, please use "${$.magenta(a)}" instead.${s?`
${s}`:""}`),a.includes(".")){const l=a.split(".");let r=e;l.forEach((o,u)=>{u!==l.length-1?(r[o]=r[o]||{},r=r[o]):r[o]=e[n]})}else e[a]=e[n];delete e[n]}},G=e=>{S({options:e,deprecatedOption:"urls",newOption:"extraUrls"}),S({options:e,deprecatedOption:"exclude",newOption:"excludeUrls"}),S({options:e,deprecatedOption:"outFile",newOption:"sitemapFilename"}),S({options:e,deprecatedOption:"dateFormatter",newOption:"modifyTimeGetter"})},F=[],E=e=>({defaultPath:e.path.replace(e.pathLocale,"/"),pathLocale:e.pathLocale}),M=(e,n)=>{const{changefreq:a,excludeUrls:s=["/404.html"],modifyTimeGetter:p=t=>{var c;return(c=t.data.git)!=null&&c.updatedTime?new Date(t.data.git.updatedTime).toISOString():""}}=n,{pages:l,options:{base:r,locales:o}}=e,u=l.reduce((t,c)=>{const{defaultPath:g,pathLocale:f}=E(c),m=t.get(g)||[];return m.push(f),t.set(g,m)},new Map),h=new Map;return l.forEach(t=>{const c=t.frontmatter.sitemap||{},g=(t.frontmatter.head||[]).find(i=>i[1].name==="robots");if((g?(g[1].content||"").split(/,/u).map(i=>i.trim()).includes("noindex"):c.exclude)||s.includes(t.path))return;const f=p(t),{defaultPath:m}=E(t),w=u.get(m)||[];let v=[];w.length>1&&(e.env.isDebug&&w.forEach(i=>{!o[i].lang&&!F.includes(i)&&(d.warn(`'lang' option for ${i} is missing`),F.push(i))}),v=w.map(i=>{var L;return{lang:((L=o[i])==null?void 0:L.lang)||"en",url:`${r}${O(m.replace(/^\//u,i))}`}}));const y={...a?{changefreq:a}:{},links:v,...f?{lastmod:f}:{},...c};e.env.isDebug&&d.info(`sitemap option for ${t.path}: ${JSON.stringify(y,null,2)}`),h.set(t.path,y)}),h},U=async(e,n)=>{const{extraUrls:a=[],xmlNameSpace:s}=n,p=T(n.hostname)?b(n.hostname):`https://${b(n.hostname)}`,l=n.sitemapFilename?O(n.sitemapFilename):"sitemap.xml",{dir:r,options:{base:o}}=e;d.load(`Generating sitemap to ${$.cyan(`/${l}`)}`),await new Promise(h=>{const t=new D({hostname:p,...s?{xmlns:s}:{}}),c=M(e,n),g=r.dest(l),f=x.createWriteStream(g);t.pipe(f),c.forEach((m,w)=>t.write({url:`${o}${O(w)}`,...m})),a.forEach(m=>t.write({url:`${o}${O(m)}`})),t.end(()=>{h()})}),d.succeed();const u=r.dest("robots.txt");if(x.existsSync(u)){d.load(`Appended sitemap path to ${$.cyan("robots.txt")}`);const h=`${(await x.readFile(u,{encoding:"utf8"})).replace(/^Sitemap: .*$/u,"")}
Sitemap: ${p}${o}${l}
`;await x.writeFile(u,h,{flag:"w"}),d.succeed()}},q=(e,n=!1)=>a=>{n&&G(e),a.env.isDebug&&d.info("Options:",e);const s={name:"vuepress-plugin-sitemap2"};return e.hostname?{...s,onGenerated:p=>U(p,e)}:(d.error(`Option ${$.magenta("hostname")} is required!`),s)};export{q as sitemapPlugin};
//# sourceMappingURL=index.js.map
